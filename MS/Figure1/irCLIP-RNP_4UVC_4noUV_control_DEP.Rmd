---
title: "irCLIP-RNP dataset to compare noUV vs UVC samples from two gel sections ranging from 30-70kDa and 70-350kDa"
author: "Luca Ducoli"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: 
    latex_engine: xelatex
    pandoc_args: --listings
    includes:
      in_header: preamble.tex
  html_document:
    df_print: paged
---

This is the pipeline used to analyze the HNRNPC irCLIP-RNP datasets of 4 noUV and 4 UVC samples. We have subjected to MS two gel sections ranging from 30 to 70kDa (named "free RNA ligation zone") and from 70 to 350KDa (named "whole RNP zone"). The experiment was performed in 4 independent replicates in HEK293T cells.

# 1. Prepare the dataset
```{r, message=FALSE, warning=FALSE}
# Load the libraries
library(formatR)
library(DEP2)
library(tidyverse)
library(ggpubr)
library(Clipper)
library(viridis)
library(patchwork)
library(hrbrthemes)
library(igraph)
library(ggraph)
library(colormap)
library(UpSetR)
library(ggplot2)
library(arcdiagram)
library(pheatmap)
library(grid)
library(DESeq2)
library(corrplot)
library(psych)
library(paletteer)
library(data.table)
```

In the first step, we prepared the dataset to create a SummarizedExperiment object starting from the proteinGroups.txt output file from MaxQuant.
```{r warning=FALSE, message=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
#Load data
data <- read.csv("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/irCLIP-RNP_control/0_4noUV_4UVC/0_Data/proteinGroups.txt",sep = "\t")

#Remove RPL proteins
data <- data[-grep("RPL", data$Gene.names),]

#Generate unique names and ids
unique_pg <- make_unique(data, name = "Gene.names", ids = "Protein.IDs")
unique_pg <- unique_pg %>% arrange(name)

#Get the LFQ columns
ecols <- grep("LFQ.intensity.", colnames(unique_pg))

#Keep isoform with higher LFQ intensity
iso <- grep("\\.\\d+$", unique_pg$name)
rbp <- gsub("\\.1", "", c(unique_pg$name[iso]))

#Find original row name of the isoform with higher intensity
find_max_value <- function(rbp) {
  filtered_df <- unique_pg[unique_pg$name %like% rbp, grep("LFQ.intensity.", colnames(unique_pg)) ]
  filtered_df$rowSums <- rowSums(filtered_df[, grep("LFQ.intensity.", colnames(filtered_df))])
  max_value <- which.max(filtered_df$rowSums)
  rownames <- rownames(filtered_df)[-max_value]
  return(rownames)
}
max_iso <- c(unlist(lapply(rbp, find_max_value)))

#Remove low intensity isoforms
unique_pg <- unique_pg[!(rownames(unique_pg) %in% max_iso),]

head(unique_pg, n = 2)
```

# 2. Create a SummarizedExperiment
We used the following design to create a SummarizedExperiment.
```{r warning=FALSE, message=FALSE}
#Load design matrix
design <- read.delim("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/irCLIP-RNP_control/0_4noUV_4UVC/0_Data/Design_matrix.txt")
design
```

```{r warning=FALSE, message=FALSE}
set.seed(3)
se <- make_se(unique_pg, columns = ecols, expdesign = design)

#Filter and impute
filt <- filter_se(se,thr = 0, filter_formula = ~ Reverse != '+' & Potential.contaminant !="+" & Peptides > 1 & Unique.peptides > 0)
write.table(as.data.frame(filt@assays@data@listData), file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/irCLIP-RNP_control/0_4noUV_4UVC/3_DEP/HNRNPC_4noUV_4UVC_LFQ_intensity_raw.txt", row.names = TRUE, sep = "\t", quote = F)
norm <- normalize_vsn(filt)
se_imp <- DEP2::impute(norm,fun = "QRILC")
```

# 3. Correlation analysis
We first performed a correlation analysis to compare noUV and UVC samples from the two gel sections.
```{r message=FALSE, warning=FALSE}
#Prepare matrix for clustering
se_log2 <- assay(se_imp)
se_log2 <- as.matrix(se_log2)

#Calculate the correlation and correlation test matrix
cormat <- round(cor(se_log2),2)

#Calculate the clustering
hc <- hclust(as.dist((1-cormat)/2), method = "ward.D2")
sub_grp <- cutree(hc, k = 4)

#Plot dendogram
plot(hclust(as.dist((1-cormat)/2), method = "ward.D2"), cex=0.5)
rect.hclust(hc, k = 4, border = 2:5)
```

```{r message=FALSE, warning=FALSE, results='hide'}
#Save dendogram as pdf
pdf("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/irCLIP-RNP_control/0_4noUV_4UVC/2_Correlation/Dendo.pdf")
plot(hclust(as.dist((1-cormat)/2), method = "ward.D2"), cex=0.5)
rect.hclust(hc, k = 4, border = 2:5)
dev.off()
```

```{r warning=FALSE, message=FALSE, fig.width = 10, fig.height = 10}
#Reorder according to clustering results
hc1 <- as.dendrogram(hc)
ord.hc1 <- order.dendrogram(hc1)
cormat.ord <- cormat[ord.hc1,ord.hc1]

#Determine the color
my.breaks <- c(seq(-1, 1, by=0.01))
my.colors <- rev(c(paletteer_c("grDevices::YlGnBu", length(my.breaks)/2), rep("#FFFFFF", length(my.breaks)/2)))

#Generate correlogram
corrplot(cormat.ord, method = "color", col = my.colors, number.font = 1, number.cex = 1 , order = "original",
    #addCoef.col = "black", 
    addgrid.col = "black",
    tl.col = "black", diag = TRUE)
```

```{r message=FALSE, warning=FALSE, results='hide'}
#Save the correlation heatmap as pdf
pdf("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/irCLIP-RNP_control/0_4noUV_4UVC/2_Correlation/Correlogram.pdf", height = 10, width = 10)
corrplot(cormat.ord, method = "color", col = my.colors, number.font = 1, number.cex = 1 , order = "original",
    addgrid.col = "black", tl.col = "black", diag = TRUE)
dev.off()
```

# 4. Perform enrichment analysis using DEP
To perform the enrichment analysis, we tested every condition against the UVC samples coming from the highest gel section using the DEP2 R package (PMID: 37624922).
```{r message=FALSE, warning=FALSE}
#DEP analysis function
DEP_analysis <- function(se, a) {
  diff <- test_diff(se, type = "control", control = a, fdr.type = "BH")
  dep <- add_rejections(diff, alpha = 0.1, lfc = 0)
  results <- get_results(dep)
  return(list(se = se, diff = diff, dep = dep, 
              results = results))
}

#Run DEP analysis
se_DE <- DEP_analysis(se =  se_imp,a = "UVC_high")

head(se_DE$results)

#Save imputed LFQ intensities
write.table(as.data.frame(se_DE$dep@assays@data@listData), file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/irCLIP-RNP_control/0_4noUV_4UVC/3_DEP/HNRNPC_4noUV_4UVC_LFQ_intensity.txt", row.names = TRUE, sep = "\t", quote = F)

write.table(se_DE$results, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/irCLIP-RNP_control/0_4noUV_4UVC/3_DEP/HNRNPC_4noUV_4UVC_res_LFQ_intensity.txt", row.names = FALSE, sep = "\t", quote = F)
```

# 5. Heatmap of detected proteins
We generated a heatmap using the imputed intensities of all the proteins that were detected through irCLIP-RNP in at least one condition. We provided also an annotation regarding the significance against noUV "low" (free RNA ligation zone) and "high" (whole RNP zone) gel sections as well as UVC "low" gel section (FDR < 0.05 and FC > 3).
```{r warning=FALSE, message=FALSE, fig.width = 10, fig.height = 3}
#Create heatmap of imputed intensities
table.hm <- se_log2[,c(1,3,5,7,2,4,6,8,9,11,13,15,10,12,14,16)]

#Color breaks
my.breaks <- c(seq(15, 29, by=0.1))
my.colors <- c(colorRampPalette(colors = rev(c("#6c2c73","#aa0663", "#c93a56", "#db664e", "#e4904f", "#e5b961", "#eec67b", "#f7d394", "#ffe0ae", "#ffe0cd", "#ffe7ec", "#fff3fd", "#fdfdfd")))(length(my.breaks)))

#Annotation about significance
se_DE$results$noUV_low_sign <- ifelse(se_DE$results$noUV_low_vs_UVC_high_p.adj < 0.05 & se_DE$results$noUV_low_vs_UVC_high_ratio < -log2(3), 1, 0)
se_DE$results$noUV_high_sign <- ifelse(se_DE$results$noUV_high_vs_UVC_high_p.adj < 0.05 & se_DE$results$noUV_high_vs_UVC_high_ratio < -log2(3), 1, 0)
se_DE$results$UVC_low_sign <- ifelse(se_DE$results$UVC_low_vs_UVC_high_p.adj < 0.05 & se_DE$results$UVC_low_vs_UVC_high_ratio < -log2(3), 1, 0)

annotation <- se_DE$results[,c(13,14,15,20,21,22)]
rownames(annotation) <- se_DE$results$name
annotation[annotation == 1] <- "Yes"
annotation[annotation == 0] <- "No"
annotation$noUV_low_sign <- as.factor(annotation$noUV_low_sign)
annotation$noUV_high_sign <- as.factor(annotation$noUV_high_sign)
annotation$UVC_low_sign <- as.factor(annotation$UVC_low_sign)
annotation$avglogfc <- rowMeans(annotation[1:3])

annotation <- annotation %>% arrange(noUV_high_sign, UVC_low_sign, noUV_low_sign, -1*avglogfc)
table.hm <- table.hm[match(rownames(annotation), rownames(table.hm)),]

write.table(annotation, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/irCLIP-RNP_control/0_4noUV_4UVC/3_DEP/HNRNPC_4noUV_4UVC_res_sign_prot.txt", row.names = TRUE, sep = "\t", quote = F)

ann_colors = list(noUV_low_sign = c("Yes"="darkgreen", "No"="white"), noUV_high_sign = c("Yes"="orange", "No"="white"), UVC_low_sign = c("Yes"="darkblue", "No"="white"))

#Make the heatmap
pheatmap(
  mat               = t(table.hm),
  annotation_col = annotation[c(5,4,6)],
  annotation_colors = ann_colors,
  color = my.colors,
  breaks = my.breaks,
  cellwidth = 4,
  cellheight = 4,
  show_colnames     = TRUE,
  show_rownames     = TRUE,
  drop_levels       = TRUE,
  fontsize          = 3,
  cluster_rows      = FALSE,
  cluster_cols      = FALSE,
  scale             = "none",
  angle_col = 90,
  gaps_row = c(8)
)
```

```{r message=FALSE, warning=FALSE, results='hide'}
#Save the heatmap
pheatmap(
  mat               = t(table.hm),
  annotation_col = annotation[c(5,4,6)],
  annotation_colors = ann_colors,
  color = my.colors,
  breaks = my.breaks,
  cellwidth = 4,
  cellheight = 4,
  show_colnames     = TRUE,
  show_rownames     = TRUE,
  drop_levels       = TRUE,
  fontsize          = 3,
  cluster_rows      = FALSE,
  cluster_cols      = FALSE,
  scale             = "none",
  angle_col = 90,
  gaps_row = c(8),
  filename = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/irCLIP-RNP_control/0_4noUV_4UVC/3_DEP/all_prot_heatmap_LFQ.pdf"
)
```

All the visualizations were saved as pdf and modified in illustrator.

```{r}
sessionInfo()
```





