---
title: "irCLIP-RNP dataset from 13 RBPs in HEK293T and HepG2"
author: "Luca Ducoli"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: 
    latex_engine: xelatex
    pandoc_args: --listings
    includes:
      in_header: preamble.tex
  html_document:
    df_print: paged
---

This is the pipeline used to analyze the label-free irCLIP-RNP datasets for 13 RBPs. The experiment consisted of 2 replicates UVC and 1 replicate no-UV samples derived from HEK293T and HepG2 cells.

# 1. Prepare the dataset
```{r warning=FALSE, message=FALSE}
#Needed libraries
library(DEP2)
library(tidyverse)
library(ggplot2)
library(data.table)
library(pheatmap)
library(RColorBrewer)
library(gplots)
library(hrbrthemes)
library(pacman)
library(textshape)
library(ggExtra)
library(viridis)
library(purrr)
library(hexbin)
library(DESeq2)
library(ggpubr)
library(UpSetR)
library(dplyr)
library(Clipper)
library(factoextra)
library(paletteer)
library(corrplot)
library(psych)
library(ggpmisc)
library(gprofiler2)
library(viridis)
```
In the first step, we prepared the dataset to create a SummarizedExperiment object starting from the proteinGroups.txt output file from MaxQuant.

```{r warning=FALSE, message=FALSE}
# Open proteinGroups.txt results from MaxQuant
data <- read.delim("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/0_Data/proteinGroups.txt")

#Remove RPL proteins
data <- data[-grep("RPL", data$Gene.names),]

#Generate unique names and ids
unique_pg <- make_unique(data, name = "Gene.names", ids = "Protein.IDs")
unique_pg <- unique_pg %>% arrange(name)

#Get the columns
ecols <- grep("LFQ.intensity.", colnames(unique_pg))

#Keep isoform with higher LFQ intensity
iso <- grep("\\.\\d+$", unique_pg$name)
rbp <- gsub("\\.1", "", c(unique_pg$name[iso]))

#Find original row name of the isoform with higher intensity
find_max_value <- function(rbp) {
  filtered_df <- unique_pg[unique_pg$name %like% rbp, grep("LFQ.intensity.", colnames(unique_pg)) ]
  filtered_df$rowSums <- rowSums(filtered_df[, grep("LFQ.intensity.", colnames(filtered_df))])
  max_value <- which.max(filtered_df$rowSums)
  rownames <- rownames(filtered_df)[-max_value]
  return(rownames)
}
max_iso <- c(unlist(lapply(rbp, find_max_value)))

#Remove low intensity isoforms
unique_pg <- unique_pg[!(rownames(unique_pg) %in% max_iso),]

# Remove all proteins detected in IgG
unique_pg <- subset(unique_pg, LFQ.intensity.BZ93 == 0 & LFQ.intensity.BZ94 == 0)

# Remove IgG column
unique_pg <- unique_pg[,-c(500,501)]
```

# 2. Create a SummarizedExperiment
We used the following design to create a SummarizedExperiment.

```{r warning=FALSE, message=FALSE}
# Load design matrix
design <- read.delim("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/0_Data/Design_matrix.txt")
design
```

```{r message=FALSE, warning=FALSE}
# Create a SummarizedExperiment
se <- make_se(unique_pg, columns = ecols, expdesign = design)
se_UVC <- se[,se$crosslinking == "UVC"]
se_UVC <- filter_se(se_UVC, thr = 0, filter_formula = ~ Reverse != '+' & Potential.contaminant !="+" & Peptides > 1 & Unique.peptides > 0)
se <- se[rownames(se_UVC),]
write.table(as.data.frame(se@assays@data@listData), file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/All_se_LFQ_intensity_raw.txt", row.names = TRUE, sep = "\t", quote = F)

#Subset se by cell line
HEK293T_se <- se[,se$cell_type == "293T"]
HepG2_se <- se[,se$cell_type == "HepG2"]

# Subset the se according to the proteins
ABCF1_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "ABCF1"]
DDX5_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "DDX5" ]
FUS_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "FUS" ]
HNRNPA2B1_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "HNRNPA2B1" ]
HNRNPC_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "HNRNPC" ]
HNRNPM_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "HNRNPM" ]
HNRNPU_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "HNRNPU" ]
ILF2_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "ILF2" ]
ILF3_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "ILF3" ]
NAT10_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "NAT10" ]
NONO_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "NONO" ]
RBFOX2_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "RBFOX2" ]
SFPQ_HEK293T_se <- HEK293T_se[,HEK293T_se$rbp == "SFPQ" ]

ABCF1_HepG2_se <- HepG2_se[,HepG2_se$rbp == "ABCF1"]
DDX5_HepG2_se <- HepG2_se[,HepG2_se$rbp == "DDX5" ]
FUS_HepG2_se <- HepG2_se[,HepG2_se$rbp == "FUS" ]
HNRNPA2B1_HepG2_se <- HepG2_se[,HepG2_se$rbp == "HNRNPA2B1" ]
HNRNPC_HepG2_se <- HepG2_se[,HepG2_se$rbp == "HNRNPC" ]
HNRNPM_HepG2_se <- HepG2_se[,HepG2_se$rbp == "HNRNPM" ]
HNRNPU_HepG2_se <- HepG2_se[,HepG2_se$rbp == "HNRNPU" ]
ILF2_HepG2_se <- HepG2_se[,HepG2_se$rbp == "ILF2" ]
ILF3_HepG2_se <- HepG2_se[,HepG2_se$rbp == "ILF3" ]
NAT10_HepG2_se <- HepG2_se[,HepG2_se$rbp == "NAT10" ]
NONO_HepG2_se <- HepG2_se[,HepG2_se$rbp == "NONO" ]
RBFOX2_HepG2_se <- HepG2_se[,HepG2_se$rbp == "RBFOX2" ]
SFPQ_HepG2_se <- HepG2_se[,HepG2_se$rbp == "SFPQ" ]
```

# 3. Perform FDR analysis using ClipperR 
We next prepared the data for ClipperR analysis by comparing the noUV samples vs UVC for each cell line. We compared noUV (1 replicate) and UVC samples (2 replicates for each RBP in each cell line).

```{r message=FALSE, warning=FALSE}
set.seed(3)
# Clipper function
clipper_f <- function (flt) {
  flt_temp <- flt[,flt$crosslinking == "UVC"]
  flt_temp <- filter_se(flt_temp, thr = 0)
  flt <- flt[rownames(flt_temp), ]
  imputed <- DEP2::impute(flt, fun = "QRILC")
  data <- as.data.frame(assay(imputed))
  clipper = Clipper(score.exp = as.matrix(data[,c(2,3)]), score.back = as.matrix(data[,-c(2,3)]), FDR = 0.05, analysis = "e")
  data$FDR <- clipper$q
  data <- cbind(data, rowMeans(data[,c(2,3)])-data[1])
  colnames(data)[5] <- c("logFC")
  deg <- subset(data, FDR < 0.1 & logFC > log2(3))
  return(list(imp = imputed, all = data, deg = deg))
}

# Run Clipper
ABCF1_HEK293T_clipper <- clipper_f(ABCF1_HEK293T_se)
DDX5_HEK293T_clipper <- clipper_f(DDX5_HEK293T_se)
FUS_HEK293T_clipper <- clipper_f(FUS_HEK293T_se)
HNRNPA2B1_HEK293T_clipper <- clipper_f(HNRNPA2B1_HEK293T_se)
HNRNPC_HEK293T_clipper <- clipper_f(HNRNPC_HEK293T_se)
HNRNPM_HEK293T_clipper <- clipper_f(HNRNPM_HEK293T_se)
HNRNPU_HEK293T_clipper <- clipper_f(HNRNPU_HEK293T_se)
ILF2_HEK293T_clipper <- clipper_f(ILF2_HEK293T_se)
ILF3_HEK293T_clipper <- clipper_f(ILF3_HEK293T_se)
NAT10_HEK293T_clipper <- clipper_f(NAT10_HEK293T_se)
NONO_HEK293T_clipper <- clipper_f(NONO_HEK293T_se)
RBFOX2_HEK293T_clipper <- clipper_f(RBFOX2_HEK293T_se)
SFPQ_HEK293T_clipper <- clipper_f(SFPQ_HEK293T_se)

ABCF1_HepG2_clipper <- clipper_f(ABCF1_HepG2_se)
DDX5_HepG2_clipper <- clipper_f(DDX5_HepG2_se)
FUS_HepG2_clipper <- clipper_f(FUS_HepG2_se)
HNRNPA2B1_HepG2_clipper <- clipper_f(HNRNPA2B1_HepG2_se)
HNRNPC_HepG2_clipper <- clipper_f(HNRNPC_HepG2_se)
HNRNPM_HepG2_clipper <- clipper_f(HNRNPM_HepG2_se)
HNRNPU_HepG2_clipper <- clipper_f(HNRNPU_HepG2_se)
ILF2_HepG2_clipper <- clipper_f(ILF2_HepG2_se)
ILF3_HepG2_clipper <- clipper_f(ILF3_HepG2_se)
NAT10_HepG2_clipper <- clipper_f(NAT10_HepG2_se)
NONO_HepG2_clipper <- clipper_f(NONO_HepG2_se)
RBFOX2_HepG2_clipper <- clipper_f(RBFOX2_HepG2_se)
SFPQ_HepG2_clipper <- clipper_f(SFPQ_HepG2_se)

head(HNRNPC_HEK293T_clipper$deg)
```

```{r message=FALSE, warning=FALSE}
# Save the clipper results
write.table(ABCF1_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/ABCF1_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(DDX5_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/DDX5_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(FUS_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/FUS_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(HNRNPA2B1_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/HNRNPA2B1_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(HNRNPC_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/HNRNPC_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(HNRNPM_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/HNRNPM_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(HNRNPU_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/HNRNPU_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(ILF2_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/ILF2_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(ILF3_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/ILF3_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(NAT10_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/NAT10_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(NONO_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/NONO_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(RBFOX2_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/RBFOX2_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(SFPQ_HEK293T_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/SFPQ_HEK293T_clipper_results.txt", row.names = TRUE, sep = "\t")

write.table(ABCF1_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/ABCF1_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(DDX5_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/DDX5_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(FUS_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/FUS_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(HNRNPA2B1_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/HNRNPA2B1_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(HNRNPC_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/HNRNPC_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(HNRNPM_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/HNRNPM_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(HNRNPU_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/HNRNPU_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(ILF2_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/ILF2_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(ILF3_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/ILF3_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(NAT10_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/NAT10_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(NONO_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/NONO_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(RBFOX2_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/RBFOX2_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
write.table(SFPQ_HepG2_clipper$all, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/SFPQ_HepG2_clipper_results.txt", row.names = TRUE, sep = "\t")
```

# 4. Visualization of the results
For the visualization, we first generated a list of all UVC-enriched proteins. Only proteins with an FDR < 0.1 and a  FC vs noUV > 3 in at least one condition were categorized as UVC-enriched.

```{r warning=FALSE, message=FALSE}
#Get total unique UVC proteins
UVC_all_HEK293T <- unique(c(rownames(ABCF1_HEK293T_clipper$deg), rownames(DDX5_HEK293T_clipper$deg), rownames(FUS_HEK293T_clipper$deg), 
                            rownames(HNRNPA2B1_HEK293T_clipper$deg),rownames(HNRNPC_HEK293T_clipper$deg),rownames(HNRNPM_HEK293T_clipper$deg),
                            rownames(HNRNPU_HEK293T_clipper$deg), rownames(ILF2_HEK293T_clipper$deg), rownames(ILF3_HEK293T_clipper$deg),
                            rownames(NAT10_HEK293T_clipper$deg), rownames(NONO_HEK293T_clipper$deg), rownames(RBFOX2_HEK293T_clipper$deg),
                            rownames(SFPQ_HEK293T_clipper$deg)))

UVC_all_HepG2 <- unique(c(rownames(ABCF1_HepG2_clipper$deg), rownames(DDX5_HepG2_clipper$deg), rownames(FUS_HepG2_clipper$deg), 
                          rownames(HNRNPA2B1_HepG2_clipper$deg),rownames(HNRNPC_HepG2_clipper$deg), rownames(HNRNPM_HepG2_clipper$deg), 
                          rownames(HNRNPU_HepG2_clipper$deg), rownames(ILF2_HepG2_clipper$deg), rownames(ILF3_HepG2_clipper$deg),
                          rownames(NAT10_HepG2_clipper$deg), rownames(NONO_HepG2_clipper$deg), rownames(RBFOX2_HepG2_clipper$deg),
                          rownames(SFPQ_HepG2_clipper$deg)))

UVC_all <- unique(c(UVC_all_HEK293T, UVC_all_HepG2))
rowData <- as.data.frame(rowData(se))
UVC_rowData <- rowData[UVC_all,]

write.table(UVC_rowData, file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/UVC_proteins_All.txt", row.names = FALSE, sep = "\t", quote = FALSE)

```

## Barplot of the UVC-enriched proteins between cell type
```{r warning=FALSE, message=FALSE, fig.width = 7, fig.height = 4}
# Function to create the binary table
fromList <- function (input) {
  elements <- unique(unlist(input))
  data <- unlist(lapply(input, function(x) {
    x <- as.vector(match(elements, x))
  }))
  data[is.na(data)] <- as.integer(0)
  data[data != 0] <- as.integer(1)
  data <- data.frame(matrix(data, ncol = length(input), byrow = F))
  data <- data[which(rowSums(data) != 0), ]
  names(data) <- names(input)
  row.names(data) <- elements
  return(data)
}

# Generate a table how many of the UVC proteins are in common between cell types
celltype <- function (input, input2) {
list <- list(H293T = rownames(input),HepG2 =  rownames(input2))
list <- as.data.frame(fromList(list))
list$type <- factor(paste(list$H293T, list$HepG2, sep = "_"))
HEK293T <- rownames(subset(list, type %in% c("1_0", "1_1")))
HepG2 <- rownames(subset(list, type %in% c("0_1", "1_1")))
list <- list %>% dplyr::count(type)
return(list("celltype" = list, "HEK293T" = HEK293T, "HepG2" = HepG2))
}

ABCF1_list <- celltype(ABCF1_HEK293T_clipper$deg, ABCF1_HepG2_clipper$deg)
ABCF1_list$celltype$name <- "ABCF1"
DDX5_list <- celltype(DDX5_HEK293T_clipper$deg, DDX5_HepG2_clipper$deg)
DDX5_list$celltype$name <- "DDX5"
FUS_list <- celltype(FUS_HEK293T_clipper$deg, FUS_HepG2_clipper$deg)
FUS_list$celltype$name <- "FUS"
HNRNPA2B1_list <- celltype(HNRNPA2B1_HEK293T_clipper$deg, HNRNPA2B1_HepG2_clipper$deg)
HNRNPA2B1_list$celltype$name <- "HNRNPA2B1"
HNRNPC_list <- celltype(HNRNPC_HEK293T_clipper$deg, HNRNPC_HepG2_clipper$deg)
HNRNPC_list$celltype$name <- "HNRNPC"
HNRNPM_list <- celltype(HNRNPM_HEK293T_clipper$deg, HNRNPM_HepG2_clipper$deg)
HNRNPM_list$celltype$name <- "HNRNPM"
HNRNPU_list <- celltype(HNRNPU_HEK293T_clipper$deg, HNRNPU_HepG2_clipper$deg)
HNRNPU_list$celltype$name <- "HNRNPU"
ILF2_list <- celltype(ILF2_HEK293T_clipper$deg, ILF2_HepG2_clipper$deg)
ILF2_list$celltype$name <- "ILF2"
ILF3_list <- celltype(ILF3_HEK293T_clipper$deg, ILF3_HepG2_clipper$deg)
ILF3_list$celltype$name <- "ILF3"
NAT10_list <- celltype(NAT10_HEK293T_clipper$deg, NAT10_HepG2_clipper$deg)
NAT10_list$celltype$name <- "NAT10"
NONO_list <- celltype(NONO_HEK293T_clipper$deg, NONO_HepG2_clipper$deg)
NONO_list$celltype$name <- "NONO"
RBFOX2_list <- celltype(RBFOX2_HEK293T_clipper$deg, RBFOX2_HepG2_clipper$deg)
RBFOX2_list$celltype$name <- "RBFOX2"
SFPQ_list <- celltype(SFPQ_HEK293T_clipper$deg, SFPQ_HepG2_clipper$deg)
SFPQ_list$celltype$name <- "SFPQ"

# Combine all results for each RBP to be used in ggplot
all <- rbind(ABCF1_list$celltype, DDX5_list$celltype, FUS_list$celltype, HNRNPA2B1_list$celltype, HNRNPC_list$celltype, HNRNPM_list$celltype, HNRNPU_list$celltype, ILF2_list$celltype, ILF3_list$celltype, NAT10_list$celltype, NONO_list$celltype, RBFOX2_list$celltype, SFPQ_list$celltype)

# Generate the plot
ggplot(all, aes(fill=type, y=n, x=name)) + 
  geom_bar(position="stack", stat="identity") +
  scale_fill_viridis(discrete = T, labels=c('HepG2_only', '293T_only', "both")) +
  theme_bw() +
  theme(axis.title.x = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #, legend.position="none") +
  xlab("") +  ylab("# UVC-enrichded proteins")
```

```{r message=FALSE, warning=FALSE, results='hide'}
# Save the barplot as pdf
pdf("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/1_Visualization/BulkMS_UVC_proteins_stacked.pdf", height = 5, width = 10)
ggplot(all, aes(fill=type, y=n, x=name)) + 
  geom_bar(position="stack", stat="identity") +
  scale_fill_viridis(discrete = T) +
  theme_bw() +
  theme(axis.title.x = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position="none") +
  xlab("") +  ylab("# UVC-enrichded proteins")
dev.off()
```

## GO analysis of UVC-enriched proteins
```{r message=FALSE, warning=FALSE, fig.width = 6, fig.height = 8}
set.seed(3)
#Run GO analysis on UVC data
gp.res = gost(rownames(UVC_rowData), organism = "hsapiens")

#Take top 20 terms for each source
gp.res <- gp.res$result %>% group_by(source) %>% dplyr::slice(1:10)
gp.bp <- gp.res[gp.res$source %in% c("GO:BP", "GO:CC", "GO:MF"),]
gp.bp$term_name <- factor(gp.bp$term_name, levels = unique(gp.bp$term_name))
gp.bp$source <- factor(gp.bp$source, levels = unique(gp.bp$source))

#Prepare the bubble plot
ggplot(data = gp.bp, aes(x = source, y = term_name, color = -log10(p_value), size = intersection_size)) + 
  geom_point() +
  scale_color_viridis(option = "D") +
  theme_bw() + 
  ylab("") + 
  xlab("") +
  theme(axis.text.y = element_text(vjust = 1, hjust=1), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_y_discrete(limits=rev)
```

```{r message=FALSE, warning=FALSE, results='hide'}
# Save the bubble plot as pdf
pdf("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/1_Visualization/GO_UVC_protein.pdf", height = 8, width = 5.5)
ggplot(data = gp.bp, aes(x = source, y = term_name, color = -log10(p_value), size = intersection_size)) + 
  geom_point() +
  scale_color_viridis(option = "D") +
  theme_bw() + 
  ylab("") + 
  xlab("") +
  theme(axis.text.y = element_text(vjust = 1, hjust=1), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_y_discrete(limits=rev)
dev.off()
```

## Protein expression regression analysis between cell lines
Here, we tested how the UVC-enriched proteins are correlated, in terms of expression, in the two cell lines. To do so, we relied on a previously published dataset (PMID: 22278370).

```{r message=FALSE, warning=FALSE, fig.width = 4, fig.height = 4}
# Load expression from Geiger et al.
data <- read.delim("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/3_Expression_profile/0_Reference/Expression_HEK_HepG2.txt")

#Combine the UVC-enriched proteins and the data from Geiger et al.
UVC_anno <- UVC_rowData
UVC_anno$ID <- gsub("\\-.*","",UVC_anno$ID)

data2 <- data %>% mutate(ID = str_split(Uniprot, ";")) %>% unnest(ID)

UVC_exp <- merge(UVC_anno[,515:516], data2[c(3:4,11:23)], by = "ID")

UVC_exp$rowmeans <- rowMeans(UVC_exp[5:10], na.rm = TRUE)
UVC_exp$rowmeans2 <- rowMeans(UVC_exp[11:16],  na.rm = TRUE)

UVC_exp2 <- subset(UVC_exp, rowmeans != "NaN")

UVC_exp3 <- UVC_exp2 %>% arrange(ID, -rowmeans) %>% filter(!duplicated(ID))
UVC_exp3 <- UVC_exp3[,c(1:2,5:10)]
UVC_exp3[,3:8] <- 10^UVC_exp3[3:8]

design <- data.frame(label = colnames(UVC_exp3)[3:8], condition = rep(c("H293T", "HepG2"), each = 3), replicate = rep(c("1", "2", "3"), 2))
columns <- grep("iBAQ", colnames(UVC_exp3))

#Generate a summarizedExperiment
IBAQ.se <- make_se(UVC_exp3, columns = columns, expdesign = design)
IBAQ.se <- filter_se(IBAQ.se, thr = 0)
set.seed(3)
IBAQ.se <- normalize_vsn(IBAQ.se)
IBAQ.se <- DEP2::impute(IBAQ.se, fun = "man", shift = 1.8, scale = 0.3)

UVC_exp4 <- as.data.frame(assay(IBAQ.se))

UVC_exp4$H293T_IBAQ_avg <- rowMeans(UVC_exp4[1:3], na.rm = TRUE)
UVC_exp4$HepG2_IBAQ_avg <- rowMeans(UVC_exp4[4:6],  na.rm = TRUE)

h.res.ibaq <- lm(UVC_exp4$H293T_IBAQ_avg ~ UVC_exp4$HepG2_IBAQ_avg)

UVC_exp4$predicted_iBAQ <- predict(h.res.ibaq)
UVC_exp4$residuals_iBAQ <- residuals(h.res.ibaq)

# Plot scatterplot
ggplot(data=UVC_exp4, aes(x=H293T_IBAQ_avg, y=HepG2_IBAQ_avg)) + 
  geom_point(color = "black") +
  stat_poly_line(colour = "red", linewidth=0.5) +
  stat_poly_eq(use_label(c("adj.R2", "p.value"))) +  
  theme_bw() +
  theme(legend.position = "none", panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_blank())+
  ggtitle(paste(nrow(UVC_exp4), "UVC-enriched RDAPs")) +
  xlab("log2(IBAQ intensity) in HEK293T") +
  ylab("log2(IBAQ intensity) in HepG2")

UVC_exp4_anno <- as.data.frame(rowData(IBAQ.se))
UVC_exp5 <- merge(UVC_exp4_anno[,1:2], UVC_exp4 , by = "row.names")

write.table(UVC_exp5[,-1], file = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/3_Expression_profile/Bulk_MS_Geiger_expression_intensities.txt", row.names = FALSE, sep = "\t")
```

```{r message=FALSE, warning=FALSE, results='hide'}
# Save scatterplot as pdf
pdf("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/3_Expression_profile/Bulk_MS_Geiger_expression.pdf", height = 5, width = 5)
ggplot(data=UVC_exp4, aes(x=H293T_IBAQ_avg, y=HepG2_IBAQ_avg)) + 
  geom_point(color = "black") +
  stat_poly_line(colour = "red", linewidth=0.5) +
  stat_poly_eq(use_label(c("adj.R2", "p.value"))) +  
  theme_bw() +
  theme(legend.position = "none", panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_blank())+
  ggtitle(paste(nrow(UVC_exp4), "UVC-enriched RDAPs")) +
  xlab("log2(IBAQ intensity) in HEK293T") +
  ylab("log2(IBAQ intensity) in HepG2")
dev.off()
```

## Correlation heatmap of UVC-enriched proteins between HEK293T and HepG2
```{r warning=FALSE, message=FALSE, fig.width = 7, fig.height = 4}
# Generate summarized experiment
set.seed(3)
se_imp <- se_UVC[rownames(UVC_rowData)]
se_imp <- normalize_vsn(se_imp)
se_imp <- DEP2::impute(se_imp, fun = "QRILC")

se_293T_imp <- se_imp[,se_imp$cell_type == "293T" ]
se_HepG2_imp <- se_imp[,se_imp$cell_type == "HepG2"]

# Prepare matrix for clustering
se_293T_log2 <- assay(se_293T_imp)
se_HepG2_log2 <- assay(se_HepG2_imp)

se_293T_log2 <- as.matrix(se_293T_log2)
se_HepG2_log2 <- as.matrix(se_HepG2_log2)

# Calculate the correlation
cormat_293T <- round(cor(se_293T_log2),2)
cormat_HepG2 <- round(cor(se_HepG2_log2),2)
colnames(cormat_293T) <- sub("_UVC_293T_", "_", colnames(cormat_293T))
rownames(cormat_293T) <- sub("_UVC_293T_", "_", rownames(cormat_293T))
colnames(cormat_HepG2) <- sub("_UVC_HepG2_", "_", colnames(cormat_HepG2))
rownames(cormat_HepG2) <- sub("_UVC_HepG2_", "_", rownames(cormat_HepG2))

#Calculate the clustering
hc_293T <- hclust(as.dist((1-cormat_293T)/2), method = "ward.D")
hc_HepG2 <- hclust(as.dist((1-cormat_HepG2)/2), method = "ward.D")

# Plot dendogram
plot(hclust(as.dist((1-cormat_293T)/2), method = "ward.D"), hang=-1, cex=0.5)
rect.hclust(hc_293T, k = 4, border = 2:5)
plot(hclust(as.dist((1-cormat_HepG2)/2), method = "ward.D"), hang=-1, cex=0.5)
rect.hclust(hc_HepG2, k = 4, border = 2:5)
```


```{r message=FALSE, warning=FALSE, results='hide'}
# Save dendogram as pdf
pdf("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/4_Correlation/Dendo.pdf")
plot(hclust(as.dist((1-cormat_293T)/2), method = "ward.D"),hang=-1, cex=0.5)
rect.hclust(hc_293T, k = 4, border = 2:5)
plot(hclust(as.dist((1-cormat_HepG2)/2), method = "ward.D"),hang=-1, cex=0.5)
rect.hclust(hc_HepG2, k = 4, border = 2:5)
dev.off()
```

```{r message=FALSE, warning=FALSE, fig.width = 10, fig.height = 10}
#Reorder according to clustering results
d_293T <- as.dendrogram(hc_293T)
ord.293T <- order.dendrogram(d_293T)
cormat.ord_293T <- cormat_293T[ord.293T,ord.293T]

d_HepG2 <- as.dendrogram(hc_HepG2)
ord.HepG2 <- order.dendrogram(d_HepG2)
cormat.ord_HepG2 <- cormat_HepG2[ord.HepG2,ord.HepG2]

#Determine the color
my.breaks <- c(seq(-1, 1, by=0.01))
my.colors <- rev(c(paletteer_c("grDevices::YlGnBu", length(my.breaks)/2), rep("#FFFFFF", length(my.breaks)/2)))

#Generate correlogram
corrplot(cormat.ord_293T, method = "color", col = my.colors, number.font = 1, number.cex = 1 , order = "hclust", hclust.method = "ward.D",
         addrect = 4, rect.col = 'orange', rect.lwd = 3, addgrid.col = "black", tl.col = "black", diag = TRUE)

corrplot(cormat.ord_HepG2, method = "color", col = my.colors, number.font = 1, number.cex = 1 , order = "hclust", hclust.method = "ward.D",
         addrect = 4, rect.col = 'orange', rect.lwd = 3, addgrid.col = "black", tl.col = "black", diag = TRUE)
```

```{r message=FALSE, warning=FALSE, results='hide'}
# Save the correlation heatmap as pdf
pdf("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/4_Correlation/HM_H293T_HEPG2_UVC.pdf", height = 10, width = 10)
corrplot(cormat.ord_293T, method = "color", col = my.colors, number.font = 1, number.cex = 1 , order = "hclust", hclust.method = "ward.D",
         addrect = 4, rect.col = 'orange', rect.lwd = 3, addgrid.col = "black", tl.col = "black", diag = TRUE)

corrplot(cormat.ord_HepG2, method = "color", col = my.colors, number.font = 1, number.cex = 1 , order = "hclust", hclust.method = "ward.D",
         addrect = 4, rect.col = 'orange', rect.lwd = 3, addgrid.col = "black", tl.col = "black", diag = TRUE)
dev.off()
```

## Rank plot of detected proteins
```{r fig.width = 25, fig.height = 7, message=FALSE, warning=FALSE}
#Get the ranking of the proteins
rank_plot_rbp <- function(bait) {
  rbp <- as.data.frame(assay(se_imp[,se_imp$rbp == bait]))
  rbp$name <- rownames(rbp)
  rbp$HEK293T_low_avg <- rowMeans(rbp[,grep("293T", colnames(rbp))])
  rbp$HepG2_low_avg <- rowMeans(rbp[,grep("HepG2", colnames(rbp))])
  rbp <- subset(rbp, name %in% unique(c(rownames(get(paste(bait, "HEK293T_clipper", sep = "_"))$all),rownames(get(paste(bait, "HepG2_clipper", sep = "_"))$all))))
  rbp$UVC <- paste(rbp$name %in% rownames(get(paste(bait, "HEK293T_clipper", sep = "_"))$deg), rbp$name %in% rownames(get(paste(bait, "HepG2_clipper", sep = "_"))$deg), sep = "_")
  
  plot <- ggplot(rbp, aes(x=HEK293T_low_avg, y=HepG2_low_avg, label = name)) + 
    geom_point(aes(col = UVC)) +
    scale_color_manual(values = c(`FALSE_FALSE` = "grey",  `FALSE_TRUE` = "blue", `TRUE_FALSE` = "red", `TRUE_TRUE` = "black"), labels = c("none", "HepG2_only", "HEK293T_only", "both")) +
    # ggrepel::geom_text_repel(data = subset(ABCF1_rank, Rank < 20), size = 2) +
    theme_bw() +
    theme(legend.position = "none", panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_blank(),
          plot.title = element_text(hjust = 0.5)) +
    xlab("log2(LFQ intensity) in HEK293T") +
    ylab("log2(LFQ intensity) in HepG2") +
    ggtitle(paste(bait, length(rbp$name))) +
    xlim(min(c(rbp$HEK293T_low_avg, rbp$HepG2_low_avg)),max(c(rbp$HEK293T_low_avg, rbp$HepG2_low_avg)))+
    ylim(min(c(rbp$HEK293T_low_avg, rbp$HepG2_low_avg)),max(c(rbp$HEK293T_low_avg, rbp$HepG2_low_avg)))
  return(plot)
}

ABCF1_plot <- rank_plot_rbp("ABCF1")
DDX5_plot <- rank_plot_rbp("DDX5")
FUS_plot <- rank_plot_rbp("FUS")
HNRNPA2B1_plot <- rank_plot_rbp("HNRNPA2B1")
HNRNPC_plot <- rank_plot_rbp("HNRNPC")
HNRNPM_plot <- rank_plot_rbp("HNRNPM")
HNRNPU_plot <- rank_plot_rbp("HNRNPU")
ILF2_plot <- rank_plot_rbp("ILF2")
ILF3_plot <- rank_plot_rbp("ILF3")
NAT10_plot <- rank_plot_rbp("NAT10")
NONO_plot <- rank_plot_rbp("NONO")
RBFOX2_plot <- rank_plot_rbp("RBFOX2")
SFPQ_plot <- rank_plot_rbp("SFPQ")

# options(ggrepel.max.overlaps = Inf)
ggarrange(ABCF1_plot, DDX5_plot, FUS_plot, HNRNPA2B1_plot, HNRNPC_plot, HNRNPM_plot, HNRNPU_plot, ILF2_plot, ILF3_plot, NAT10_plot, NONO_plot, RBFOX2_plot, SFPQ_plot, nrow = 2,  ncol = 7, common.legend = TRUE, legend="right")
```

```{r message=FALSE, warning=FALSE, results='hide'}
#Save the plot as pdf
pdf("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/1_Visualization/Rank_plot_all.pdf", height = 7, width = 25)
ggarrange(ABCF1_plot, DDX5_plot, FUS_plot, HNRNPA2B1_plot, HNRNPC_plot, HNRNPM_plot, HNRNPU_plot, ILF2_plot, ILF3_plot, NAT10_plot, NONO_plot, RBFOX2_plot, SFPQ_plot, nrow = 2,  ncol = 7, common.legend = TRUE, legend="right")
dev.off()
```

## Reciprocal heatmap of the bait proteins
```{r message=FALSE, warning=FALSE}
#RBP
rbp <- c("ABCF1", "DDX5", "FUS", "HNRNPA2B1", "HNRNPC", "HNRNPM", "HNRNPU", "ILF2", "ILF3.1", "NAT10", "NONO", "RBFOX2", "SFPQ")

#Filter
filt <- se
filt <- filt[rownames(filt) %in% rbp,]
set.seed(3)
se_imp <- DEP2::impute(filt,fun = "QRILC")

df_uvc_imp <- as.data.frame(assay(se_imp))

colnames(df_uvc_imp) <- str_sub(colnames(df_uvc_imp), end = -3)
cn = colnames(df_uvc_imp)
Table.hm <- sapply(unique(cn), function(g) rowMeans(df_uvc_imp[,cn==g,drop=FALSE]))
Table.hm <- Table.hm[order(rownames(Table.hm)),]
Table.hm <- Table.hm[,order(colnames(Table.hm))]

# Color breaks
my.breaks <- c(seq(17, 29, by=0.5))
my.colors <- c(colorRampPalette(colors = rev(c("#6c2c73","#aa0663", "#c93a56", "#db664e", "#e4904f", "#e5b961", "#eec67b", "#f7d394", "#ffe0ae", "#ffe0cd", "#ffe7ec", "#fff3fd", "#fdfdfd")))(length(my.breaks)))

# Make the heatmap
pheatmap(
  mat               = Table.hm[,c(grep("UVC", colnames(Table.hm)), grep("noUV", colnames(Table.hm)))],
  color = my.colors,
  breaks = my.breaks,
  cellwidth = 10,
  cellheight = 10,
  show_colnames     = TRUE,
  show_rownames     = TRUE,
  drop_levels       = TRUE,
  fontsize          = 5.5,
  cluster_rows      = FALSE,
  cluster_cols      = FALSE,
  scale             = "none",
  angle_col = 45,
  gaps_col = c(2,4,6,8,10,12,14,16,18,20,22,24,26)
)
```

```{r message=FALSE, warning=FALSE, results='hide'}
pheatmap(
  mat               = Table.hm[,c(grep("UVC", colnames(Table.hm)), grep("noUV", colnames(Table.hm)))],
  color = my.colors,
  breaks = my.breaks,
  cellwidth = 10,
  cellheight = 10,
  show_colnames     = TRUE,
  show_rownames     = TRUE,
  drop_levels       = TRUE,
  fontsize          = 5.5,
  cluster_rows      = FALSE,
  cluster_cols      = FALSE,
  scale             = "none",
  angle_col = 45,
  gaps_col = c(2,4,6,8,10,12,14,16,18,20,22,24,26),
  filename = "~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/4_Correlation/Bait_reciprocal_heatmap.pdf",
)
```

## Correlation with crosslinking efficiency
Here, we tested how the UVC-enriched proteins are correlated with crosslinking efficiency as determined by a previously published dataset in Hela cells (PMID:38423626).

```{r message=FALSE, warning=FALSE, fig.width = 5, fig.height = 5}
correlation_plot <- function(se, ct){
# Subset the se according to the proteins
ABCF1_se <- se[,se$rbp == "ABCF1"]
DDX5_se <- se[,se$rbp == "DDX5" ]
FUS_se <- se[,se$rbp == "FUS" ]
HNRNPA2B1_se <- se[,se$rbp == "HNRNPA2B1" ]
HNRNPC_se <- se[,se$rbp == "HNRNPC" ]
HNRNPM_se <- se[,se$rbp == "HNRNPM" ]
HNRNPU_se <- se[,se$rbp == "HNRNPU" ]
ILF2_se <- se[,se$rbp == "ILF2" ]
ILF3_se <- se[,se$rbp == "ILF3" ]
NAT10_se <- se[,se$rbp == "NAT10" ]
NONO_se <- se[,se$rbp == "NONO" ]
RBFOX2_se <- se[,se$rbp == "RBFOX2" ]
SFPQ_se <- se[,se$rbp == "SFPQ" ]

set.seed(3)
# Clipper function
clipper_f <- function (flt) {
  flt_temp <- flt[,flt$crosslinking == "UVC"]
  flt_temp <- filter_se(flt_temp, thr = 0)
  flt <- flt[rownames(flt_temp), ]
  imputed <- DEP2::impute(flt, fun = "QRILC")
  data <- as.data.frame(assay(imputed))
  clipper = Clipper(score.exp = as.matrix(data[,c(2,3)]), score.back = as.matrix(data[,-c(2,3)]), FDR = 0.05, analysis = "e")
  data$FDR <- clipper$q
  data <- cbind(data, rowMeans(data[,c(2,3)])-data[1])
  colnames(data)[5] <- c("logFC")
  deg <- subset(data, FDR < 0.1 & logFC > log2(3))
  return(list(imp = imputed, all = data, deg = deg))
}

# Run Clipper
ABCF1_clipper <- clipper_f(ABCF1_se)
DDX5_clipper <- clipper_f(DDX5_se)
FUS_clipper <- clipper_f(FUS_se)
HNRNPA2B1_clipper <- clipper_f(HNRNPA2B1_se)
HNRNPC_clipper <- clipper_f(HNRNPC_se)
HNRNPM_clipper <- clipper_f(HNRNPM_se)
HNRNPU_clipper <- clipper_f(HNRNPU_se)
ILF2_clipper <- clipper_f(ILF2_se)
ILF3_clipper <- clipper_f(ILF3_se)
NAT10_clipper <- clipper_f(NAT10_se)
NONO_clipper <- clipper_f(NONO_se)
RBFOX2_clipper <- clipper_f(RBFOX2_se)
SFPQ_clipper <- clipper_f(SFPQ_se)

ABCF1_clipper$all$RDAP <- rownames(ABCF1_clipper$all) %in% rownames(ABCF1_clipper$deg)
DDX5_clipper$all$RDAP <- rownames(DDX5_clipper$all) %in% rownames(DDX5_clipper$deg)
FUS_clipper$all$RDAP <- rownames(FUS_clipper$all) %in% rownames(FUS_clipper$deg)
HNRNPA2B1_clipper$all$RDAP <- rownames(HNRNPA2B1_clipper$all) %in% rownames(HNRNPA2B1_clipper$deg)
HNRNPC_clipper$all$RDAP <- rownames(HNRNPC_clipper$all) %in% rownames(HNRNPC_clipper$deg)
HNRNPM_clipper$all$RDAP <- rownames(HNRNPM_clipper$all) %in% rownames(HNRNPM_clipper$deg)
HNRNPU_clipper$all$RDAP <- rownames(HNRNPU_clipper$all) %in% rownames(HNRNPU_clipper$deg)
ILF2_clipper$all$RDAP <- rownames(ILF2_clipper$all) %in% rownames(ILF2_clipper$deg)
ILF3_clipper$all$RDAP <- rownames(ILF3_clipper$all) %in% rownames(ILF3_clipper$deg)
NAT10_clipper$all$RDAP <- rownames(NAT10_clipper$all) %in% rownames(NAT10_clipper$deg)
NONO_clipper$all$RDAP <- rownames(NONO_clipper$all) %in% rownames(NONO_clipper$deg)
RBFOX2_clipper$all$RDAP <- rownames(RBFOX2_clipper$all) %in% rownames(RBFOX2_clipper$deg)
SFPQ_clipper$all$RDAP <- rownames(SFPQ_clipper$all) %in% rownames(SFPQ_clipper$deg)

a <- read.delim("/Users/lducoli/Documents/Postdoc/PD_Papers/6_irCLIP-RNP/5_Revision/Nature_rev2/0_Appeal_letter/Images/Crosslinking_eff/Cross_eff_tabe.txt", header = TRUE)
a$norm_CL <- a$Average..CL*(a$INPUT.Avg.Intesity/max(a$INPUT.Avg.Intesity))
colnames(a)[1] <- "Row.names"

b <- data.frame(unique(c(rownames(ABCF1_clipper$all),
       rownames(DDX5_clipper$all),
       rownames(FUS_clipper$all),
       rownames(HNRNPA2B1_clipper$all),
       rownames(HNRNPC_clipper$all),
       rownames(HNRNPM_clipper$all),
       rownames(HNRNPU_clipper$all),
       rownames(ILF2_clipper$all),
       rownames(ILF3_clipper$all),
       rownames(NAT10_clipper$all),
       rownames(NONO_clipper$all),
       rownames(RBFOX2_clipper$all),
       rownames(SFPQ_clipper$all))))
colnames(b) <- "geneID"
rownames(b) <- b$geneID


se <- se[,se$cell_type == ct]
se <- se[rownames(se) %in% b$geneID]
se <- DEP2::impute(se, fun = "QRILC")
hek <- as.data.frame(assay(se))
colnames(hek) <- str_sub(colnames(hek), end = -3)
cn = colnames(hek)
hek <- as.data.frame(sapply(unique(cn), function(g) rowMeans(hek[,cn==g,drop=FALSE])))

if(ct == "293T") {
hek$ABCF1_logFC <- hek$ABCF1_UVC_293T-hek$ABCF1_noUV
hek$DDX5_logFC <- hek$DDX5_UVC_293T-hek$DDX5_noUV
hek$FUS_logFC <- hek$FUS_UVC_293T-hek$FUS_noUV
hek$HNRNPA2B1_logFC <- hek$HNRNPA2B1_UVC_293T-hek$HNRNPA2B1_noUV
hek$HNRNPC_logFC <- hek$HNRNPC_UVC_293T-hek$HNRNPC_noUV
hek$HNRNPM_logFC <- hek$HNRNPM_UVC_293T-hek$HNRNPM_noUV
hek$HNRNPU_logFC <- hek$HNRNPU_UVC_293T-hek$HNRNPU_noUV
hek$ILF2_logFC <- hek$ILF2_UVC_293T-hek$ILF2_noUV
hek$ILF3_logFC <- hek$ILF3_UVC_293T-hek$ILF3_noUV
hek$NAT10_logFC <- hek$NAT10_UVC_293T-hek$NAT10_noUV
hek$NONO_logFC <- hek$NONO_UVC_293T-hek$NONO_noUV
hek$RBFOX2_logFC <- hek$RBFOX2_UVC_293T-hek$RBFOX2_noUV
hek$SFPQ_logFC <- hek$SFPQ_UVC_293T-hek$SFPQ_noUV
hek$Row.names <- rownames(hek)
}else{hek$ABCF1_logFC <- hek$ABCF1_UVC_HepG2-hek$ABCF1_noUV
hek$DDX5_logFC <- hek$DDX5_UVC_HepG2-hek$DDX5_noUV
hek$FUS_logFC <- hek$FUS_UVC_HepG2-hek$FUS_noUV
hek$HNRNPA2B1_logFC <- hek$HNRNPA2B1_UVC_HepG2-hek$HNRNPA2B1_noUV
hek$HNRNPC_logFC <- hek$HNRNPC_UVC_HepG2-hek$HNRNPC_noUV
hek$HNRNPM_logFC <- hek$HNRNPM_UVC_HepG2-hek$HNRNPM_noUV
hek$HNRNPU_logFC <- hek$HNRNPU_UVC_HepG2-hek$HNRNPU_noUV
hek$ILF2_logFC <- hek$ILF2_UVC_HepG2-hek$ILF2_noUV
hek$ILF3_logFC <- hek$ILF3_UVC_HepG2-hek$ILF3_noUV
hek$NAT10_logFC <- hek$NAT10_UVC_HepG2-hek$NAT10_noUV
hek$NONO_logFC <- hek$NONO_UVC_HepG2-hek$NONO_noUV
hek$RBFOX2_logFC <- hek$RBFOX2_UVC_HepG2-hek$RBFOX2_noUV
hek$SFPQ_logFC <- hek$SFPQ_UVC_HepG2-hek$SFPQ_noUV
hek$Row.names <- rownames(hek)}

ABCF1 <- merge(ABCF1_clipper$all, b, by = "row.names", all.y = TRUE)
DDX5 <- merge(DDX5_clipper$all, b, by = "row.names", all.y = TRUE)
FUS <- merge(FUS_clipper$all, b, by = "row.names", all.y = TRUE)
HNRNPA2B1 <- merge(HNRNPA2B1_clipper$all, b, by = "row.names", all.y = TRUE)
HNRNPC <- merge(HNRNPC_clipper$all, b, by = "row.names", all.y = TRUE)
HNRNPM <- merge(HNRNPM_clipper$all, b, by = "row.names", all.y = TRUE)
HNRNPU <- merge(HNRNPU_clipper$all, b, by = "row.names", all.y = TRUE)
ILF2 <- merge(ILF2_clipper$all, b, by = "row.names", all.y = TRUE)
ILF3 <- merge(ILF3_clipper$all, b, by = "row.names", all.y = TRUE)
NAT10 <- merge(NAT10_clipper$all, b, by = "row.names", all.y = TRUE)
NONO <- merge(NONO_clipper$all, b, by = "row.names", all.y = TRUE)
RBFOX2 <- merge(RBFOX2_clipper$all, b, by = "row.names", all.y = TRUE)
SFPQ <- merge(SFPQ_clipper$all, b, by = "row.names", all.y = TRUE)

ABCF1 <- merge(ABCF1, hek %>% dplyr::select(ABCF1_logFC, Row.names), by = "Row.names")
DDX5 <- merge(DDX5, hek %>% dplyr::select(DDX5_logFC, Row.names), by = "Row.names")
FUS <- merge(FUS, hek %>% dplyr::select(FUS_logFC, Row.names), by = "Row.names")
HNRNPA2B1 <- merge(HNRNPA2B1, hek %>% dplyr::select(HNRNPA2B1_logFC, Row.names), by = "Row.names")
HNRNPC <- merge(HNRNPC, hek %>% dplyr::select(HNRNPC_logFC, Row.names), by = "Row.names")
HNRNPM <- merge(HNRNPM, hek %>% dplyr::select(HNRNPM_logFC, Row.names), by = "Row.names")
HNRNPU <- merge(HNRNPU, hek %>% dplyr::select(HNRNPU_logFC, Row.names), by = "Row.names")
ILF2 <- merge(ILF2, hek %>% dplyr::select(ILF2_logFC, Row.names), by = "Row.names")
ILF3 <- merge(ILF3, hek %>% dplyr::select(ILF3_logFC, Row.names), by = "Row.names")
NAT10 <- merge(NAT10, hek %>% dplyr::select(NAT10_logFC, Row.names), by = "Row.names")
NONO <- merge(NONO, hek %>% dplyr::select(NONO_logFC, Row.names), by = "Row.names")
RBFOX2 <- merge(RBFOX2, hek %>% dplyr::select(RBFOX2_logFC, Row.names), by = "Row.names")
SFPQ <- merge(SFPQ, hek %>% dplyr::select(SFPQ_logFC, Row.names), by = "Row.names")

ABCF1 <- merge(ABCF1, a, by = "Row.names")
DDX5 <- merge(DDX5, a, by = "Row.names")
FUS <- merge(FUS, a, by = "Row.names")
HNRNPA2B1 <- merge(HNRNPA2B1, a, by = "Row.names")
HNRNPC <- merge(HNRNPC, a, by = "Row.names")
HNRNPM <- merge(HNRNPM, a, by = "Row.names")
HNRNPU <- merge(HNRNPU, a, by = "Row.names")
ILF2 <- merge(ILF2, a, by = "Row.names")
ILF3 <- merge(ILF3, a, by = "Row.names")
NAT10 <- merge(NAT10, a, by = "Row.names")
NONO <- merge(NONO, a, by = "Row.names")
RBFOX2 <- merge(RBFOX2, a, by = "Row.names")
SFPQ <- merge(SFPQ, a, by = "Row.names")

ABCF1$logFC[is.na(ABCF1$logFC)] <- ABCF1$ABCF1_logFC[is.na(ABCF1$logFC)]
DDX5$logFC[is.na(DDX5$logFC)] <- DDX5$DDX5_logFC[is.na(DDX5$logFC)]
FUS$logFC[is.na(FUS$logFC)] <- FUS$FUS_logFC[is.na(FUS$logFC)]
HNRNPA2B1$logFC[is.na(HNRNPA2B1$logFC)] <- HNRNPA2B1$HNRNPA2B1_logFC[is.na(HNRNPA2B1$logFC)]
HNRNPC$logFC[is.na(HNRNPC$logFC)] <- HNRNPC$HNRNPC_logFC[is.na(HNRNPC$logFC)]
HNRNPM$logFC[is.na(HNRNPM$logFC)] <- HNRNPM$HNRNPM_logFC[is.na(HNRNPM$logFC)]
HNRNPU$logFC[is.na(HNRNPU$logFC)] <- HNRNPU$HNRNPU_logFC[is.na(HNRNPU$logFC)]
ILF2$logFC[is.na(ILF2$logFC)] <- ILF2$ILF2_logFC[is.na(ILF2$logFC)]
ILF3$logFC[is.na(ILF3$logFC)] <- ILF3$ILF3_logFC[is.na(ILF3$logFC)]
NAT10$logFC[is.na(NAT10$logFC)] <- NAT10$NAT10_logFC[is.na(NAT10$logFC)]
NONO$logFC[is.na(NONO$logFC)] <- NONO$NONO_logFC[is.na(NONO$logFC)]
RBFOX2$logFC[is.na(RBFOX2$logFC)] <- RBFOX2$RBFOX2_logFC[is.na(RBFOX2$logFC)]
SFPQ$logFC[is.na(SFPQ$logFC)] <- SFPQ$SFPQ_logFC[is.na(SFPQ$logFC)]


all3 <- rbind(ABCF1 %>% dplyr::select(norm_CL, logFC, RDAP),
              DDX5 %>% dplyr::select(norm_CL, logFC, RDAP),
              FUS %>% dplyr::select(norm_CL, logFC, RDAP),
              HNRNPA2B1 %>% dplyr::select(norm_CL, logFC, RDAP),
              HNRNPC %>% dplyr::select(norm_CL, logFC, RDAP),
              HNRNPM %>% dplyr::select(norm_CL, logFC, RDAP),
              HNRNPU %>% dplyr::select(norm_CL, logFC, RDAP),
              ILF2 %>% dplyr::select(norm_CL, logFC, RDAP),
              ILF3 %>% dplyr::select(norm_CL, logFC, RDAP),
              NAT10 %>% dplyr::select(norm_CL, logFC, RDAP),
              NONO %>% dplyr::select(norm_CL, logFC, RDAP),
              RBFOX2 %>% dplyr::select(norm_CL, logFC, RDAP),
              SFPQ %>% dplyr::select(norm_CL, logFC, RDAP)
              )

all3$norm_CL[all3$norm_CL==0] <- min(all3$norm_C[all3$norm_CL>0])
all3$norm_CL <- log2(all3$norm_CL)
all3$RDAP[is.na(all3$RDAP)] <- FALSE
return(all3)
}

HEK293T <- correlation_plot(HEK293T_se, "293T")
HepG2 <- correlation_plot(HepG2_se, "HepG2")


plot <- ggplot(HEK293T, aes(x=logFC, y=norm_CL, color = RDAP)) + 
  geom_point() +
  xlab("log2FC(UVCvsnoUV)") +
  ylab("normalized crosslinking efficiency") + labs(color = "RDAPs") +
  scale_color_manual(values = c("grey", "orange")) +
  stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))) +
  geom_vline(xintercept = log2(3), linetype = "dashed", color = "black") +theme_bw()+
  theme(panel.grid=element_blank(), legend.position="none")
plot

plot2 <- ggplot(HepG2, aes(x=logFC, y=norm_CL, color = RDAP))+
  geom_point() +
  xlab("log2FC(UVCvsnoUV)") +
  ylab("normalized crosslinking efficiency") + labs(color = "RDAPs") +
  scale_color_manual(values = c("grey", "lightblue")) +
  stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))) +
  geom_vline(xintercept = log2(3), linetype = "dashed", color = "black") +theme_bw()+
  theme(panel.grid=element_blank(), legend.position="none")
plot2
```

```{r message=FALSE, warning=FALSE, results='hide'}
#Save the plot as pdf
pdf("~/Documents/Postdoc/PD_Projects/3_irCLIP-RNP/MS/Bulk_analysis/2_UVC_enriched/1_Visualization/CLeff_plot_HEK_HepG2.pdf", height = 5, width = 5)
plot
plot2
dev.off()
```

All the visualizations were saved as pdf and modified in illustrator.

```{r}
sessionInfo()
```



